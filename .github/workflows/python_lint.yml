name: python_lint

on:
  push:
    paths:
      - '**.py'
  pull_request:
    paths:
      - '**.py'

jobs:
  flake8_py3:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python
        uses: actions/setup-python@v1
        with:
          python-version: 3.7.4
          architecture: x64
      - name: Checkout PyTorch
        uses: actions/checkout@master
      - name: Install flake8
        run: pip install flake8
      - name: Run flake8
        uses: suo/flake8-github-action@releases/v1
        with:
          checkName: 'flake8_py3'   # NOTE: this needs to be the same as the job name
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  black_lint:
    runs-on: ubuntu-latest
    steps:
        - name: Setup
          uses: actions/checkout@v2
        - name: Check code lints with Black
          uses: psf/black@stable
        # If the above check failed, post a comment on the PR explaining the failure
        - name: Post PR comment
          if: failure()
          uses: mshick/add-pr-comment@v1
          with:
            message: |
                ## Python linting (`black`) is failing
                To keep the code consistent with lots of contributors, we run automated code consistency checks.
                To fix this CI test, please run:
                * Install [`black`](https://black.readthedocs.io/en/stable/): `pip install black`
                * Fix formatting errors in your pipeline: `black .`
                Once you push these changes the test should pass, and you can hide this comment :+1:
                We highly recommend setting up Black in your code editor so that this formatting is done automatically on save. Ask about it on Slack for help!
                Thanks again for your contribution!
            repo-token: ${{ secrets.GITHUB_TOKEN }}
            allow-repeats: false
